# Extract content from chemical papers

---

## This repository is to 
1. extract the content from chemical papers (html)
2. extract images from chemical papers (pdf)
3. extract smiles string from images by using OSRA
4. extract labels from images by using easyOCR and PaddleOCR
   1. combine segments of one label
   2. remove the similar labels by using `all-MiniLM-L6-v2 model`
5. combine labels with smiles string
6. capture the sub-image of smiles with labels
   1. save to MongoDB
7. regenerate smiles structure image by using OpenBabel 
   1. save to MongoDB
8. publish json file result to MongoDB

----
## Requirement

1. install dependency 

`pip install -r requirement.txt`

2. install `MongoDB` database

3. install OpenBabel

`brew install open-babel`

3. download OSRA docker file from this link

`https://hub.docker.com/r/daverona/osra`

4. replace `path` of the config.ini file with exact path where you clone the repo

```JSON
input_dir = path/chemwork/data/in/
output_dir = path/chemwork/data/out/
opsin_loc = path/chemwork/opsin-cli-2.7.0-jar-with-dependencies.jar
pdf_dir = path/chemwork/data/pdf/
image_in_dir = path/chemwork/image/in/
image_out_dir = path/chemwork/image/out/
smiles_dir = path/chemwork/image/smiles
remake_smile_image_dir = path/chemwork/image/remake/
```

---
## Details

1. `data` folder 
   1. `html` folder holds the raw html file of chemical papers
   2. `in` folder holds the raw html file that the program will process
   3. `out` folder holds the json result of the program
   4. `pdf` folder holds the pdf file that has the same name and content to the html file in `in` folder
2. `image` folder
   1. `in` folder temporally holds images extracted from pdf files
   2. `out` folder holds the sub-image of smiles with labels
   3. `remake` folder holds the regenerated image of OpenBabel
   4. `smiles` folder hods the file of smiles generated by OSRA
3. `mongodb` folder contains the code to save data in the database
4. `utili` folder contains codes to
   1. align smiles string with labels
   2. convert smiles string to smiles structure (OpenBabel)
   3. delete files from `in` folder
   4. run ocr
   5. run osra
   6. check data in PubChem API
   7. check similarity between labels
5. `main` file is the file to execute the program

Here is what we saved for smiles and lables
```json
{
   'alter_name': 'string',
   'alter_name_confidence': int,
   'alter_name_not_original': 'T/F',
   'pubchem_name_check': 'string',
   'alter_smiles': 'string',
   'alter_smiles_confidence': int,
   'pubchem_smiles_check': object,
   'sub_image_path': 'string',
   'openbabel_image_path': 'string',
   'sub_image_id_mongodb': 'string',
   'openbabel_image_id_mongodb': 'string'
}
```

The sample of the above json block

```json
{
   "alter_name": "CDOTA+",
   "alter_name_confidence": 0.912600040435791,
   "alter_name_not_original": "True",
   "pubchem_name_check": [],
   "alter_smiles": "CC1(C)c2cccc3c2[Co]2c4c1cccc4Oc1c2c(O3)ccc1",
   "alter_smiles_confidence": 3.48556,
   "pubchem_smiles_check": [
     {
       "formula": null,
       "smiles": "CC1(C2=[C-]C(=CC=C2)OC3=[C-]C(=CC=C3)OC4=CC=CC1=[C-]4)C.[Co+3]"
     }
   ],
   "sub_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/out/bc05412e-26b2-473e-b52f-96b92d4f4a32.png",
   "openbabel_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/remake/bc05412e-26b2-473e-b52f-96b92d4f4a32.png",
   "sub_image_id_mongodb": "6566909cf89411bd8490ac35",
   "openbabel_image_id_mongodb": "6566909df89411bd8490ac37"
}
```

1. `alter_name` is a name generated by OCR from the image which is mapping to the `names` field
2. `alter_name_confidence` lists the confidence value of the `alter_name`
3. `alter_name_not_original` means the `alter_name` is combined from several OCR results
4. `pubchem_name_check` lists any similar names in the PubChem web
5. `alter_smiles` is the smiles string generated by OSRA
6. `alter_smiles_confidence` lists the confidence value of the `alter_smiles`
7. `pubchem_smiles_check` contains the similar simles in the PubChem web
8. `sub_image_path` links to the image (`/image/out`) of the individual smiles and the related label
9. `openbabel_image_path` links to the image (`/image/remake`) which is generated by OpenBabel for the `alter_smiles`
10. `sub_image_id_mongodb` is the ID of `sub_image_path` image which is saved in the MongoDB
11. `openbabel_image_id_mongodb` is the ID of `openbabel_image_path` image which is saved in the MongoDB

---

## Run 

`python3 main.py`

---
## Appendix

The sample output of `/data/in/acs.joc.8b02978.html` file, which is saved to `/data/out/acs.joc.8b02978.json' file


```json
[
  {
    "biblio": {
      "doi": "10.1021/acs.joc.8b02978",
      "published_date": "2019-01-29T00:00:00"
    },
    "records": [
      {
        "names": [
          "CDOTA +"
        ],
        "electrochemical_potentials": [
          {
            "value": "\u20130.299",
            "type": "Ered"
          }
        ],
        "smiles": [
          {
            "alter_name": "CDOTA+",
            "alter_name_confidence": 0.912600040435791,
            "alter_name_not_original": "True",
            "pubchem_name_check": [],
            "alter_smiles": "CC1(C)c2cccc3c2[Co]2c4c1cccc4Oc1c2c(O3)ccc1",
            "alter_smiles_confidence": 3.48556,
            "pubchem_smiles_check": [
              {
                "formula": null,
                "smiles": "CC1(C2=[C-]C(=CC=C2)OC3=[C-]C(=CC=C3)OC4=CC=CC1=[C-]4)C.[Co+3]"
              }
            ],
            "sub_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/out/bc05412e-26b2-473e-b52f-96b92d4f4a32.png",
            "openbabel_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/remake/bc05412e-26b2-473e-b52f-96b92d4f4a32.png",
            "sub_image_id_mongodb": "6566909cf89411bd8490ac35",
            "openbabel_image_id_mongodb": "6566909df89411bd8490ac37"
          }
        ]
      },
      {
        "names": [
          "ADOTA + b"
        ],
        "electrochemical_potentials": [
          {
            "value": "1.814",
            "type": "Eox"
          },
          {
            "value": "\u20130.559",
            "type": "Ered"
          }
        ],
        "smiles": [
          {
            "alter_name": "ADOTA+(ADOTA*)",
            "alter_name_confidence": 0.9450149536132812,
            "alter_name_not_original": "True",
            "pubchem_name_check": [],
            "alter_smiles": "Cn1c2cccc3c2[Co]2c4c1cccc4oc1c2c(o3)ccc1",
            "alter_smiles_confidence": 4.07015,
            "pubchem_smiles_check": [
              {
                "formula": null,
                "smiles": "CN1C2=[C-]C(=CC=C2)OC3=[C-]C(=CC=C3)OC4=CC=CC1=[C-]4.[Co+3]"
              }
            ],
            "sub_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/out/73c18dbb-6119-4bf9-a05b-3485658e0a03.png",
            "openbabel_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/remake/73c18dbb-6119-4bf9-a05b-3485658e0a03.png",
            "sub_image_id_mongodb": "656690a8f89411bd8490ac39",
            "openbabel_image_id_mongodb": "656690a9f89411bd8490ac3b"
          }
        ]
      },
      {
        "names": [
          "DAOTA + b"
        ],
        "electrochemical_potentials": [
          {
            "value": "1.108",
            "type": "Eox"
          },
          {
            "value": "1.443",
            "type": "Eox"
          },
          {
            "value": "\u20130.958",
            "type": "Ered"
          }
        ],
        "smiles": [
          {
            "alter_name": "DAOTA*",
            "alter_name_confidence": 0.9654059410095215,
            "alter_name_not_original": "False",
            "pubchem_name_check": [],
            "alter_smiles": "Cn1c2cccc3c2[Co]2c4c1cccc4n(c1c2c(o3)ccc1)C",
            "alter_smiles_confidence": 3.25446,
            "pubchem_smiles_check": [
              {
                "formula": null,
                "smiles": "CN1C2=[C-]C(=CC=C2)N(C3=[C-]C(=CC=C3)OC4=CC=CC1=[C-]4)C.[Co+3]"
              }
            ],
            "sub_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/out/d4523221-f6f5-4ddf-bc3c-0f1c83ce090c.png",
            "openbabel_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/remake/d4523221-f6f5-4ddf-bc3c-0f1c83ce090c.png",
            "sub_image_id_mongodb": "656690b5f89411bd8490ac3d",
            "openbabel_image_id_mongodb": "656690b5f89411bd8490ac3f"
          }
        ]
      },
      {
        "names": [
          "CDOTA + b"
        ],
        "uvvis_spectra": [
          {
            "solvent": "CH2Cl2",
            "apparatus": "PerkinElmer Lambda 1050 UV",
            "peaks": [
              {
                "value": "535",
                "units": "nm"
              }
            ]
          }
        ],
        "quantum_yields": [
          {
            "value": "0.54",
            "solvent": "CH2Cl2",
            "type": "\u03a6f"
          }
        ],
        "fluorescence_lifetimes": [
          {
            "value": "23.1",
            "units": "ns",
            "solvent": "CH2Cl2"
          }
        ],
        "smiles": [
          {
            "alter_name": "CDOTA+",
            "alter_name_confidence": 0.912600040435791,
            "alter_name_not_original": "True",
            "pubchem_name_check": [],
            "alter_smiles": "CC1(C)c2cccc3c2[Co]2c4c1cccc4Oc1c2c(O3)ccc1",
            "alter_smiles_confidence": 3.48556,
            "pubchem_smiles_check": [
              {
                "formula": null,
                "smiles": "CC1(C2=[C-]C(=CC=C2)OC3=[C-]C(=CC=C3)OC4=CC=CC1=[C-]4)C.[Co+3]"
              }
            ],
            "sub_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/out/26334a74-854a-41f6-a041-43a51bea664d.png",
            "openbabel_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/remake/26334a74-854a-41f6-a041-43a51bea664d.png",
            "sub_image_id_mongodb": "656690c1f89411bd8490ac41",
            "openbabel_image_id_mongodb": "656690c1f89411bd8490ac43"
          }
        ]
      },
      {
        "names": [
          "CDATA + b"
        ],
        "uvvis_spectra": [
          {
            "solvent": "CH2Cl2",
            "apparatus": "PerkinElmer Lambda 1050 UV",
            "peaks": [
              {
                "value": "603",
                "units": "nm"
              }
            ]
          }
        ],
        "quantum_yields": [
          {
            "value": "0.61",
            "solvent": "CH2Cl2",
            "type": "\u03a6f"
          }
        ],
        "fluorescence_lifetimes": [
          {
            "value": "15.8",
            "units": "ns",
            "solvent": "CH2Cl2"
          }
        ],
        "smiles": [
          {
            "alter_name": "CDATA+",
            "alter_name_confidence": 0.9486436771513951,
            "alter_name_not_original": "True",
            "pubchem_name_check": [],
            "alter_smiles": "CN1c2cccc3c2[Co]2c4c1cccc4C(c1c2c(N3C)ccc1)(C)C",
            "alter_smiles_confidence": 3.242,
            "pubchem_smiles_check": [
              {
                "formula": null,
                "smiles": "CC1(C2=[C-]C(=CC=C2)N(C3=[C-]C(=CC=C3)N(C4=CC=CC1=[C-]4)C)C)C.[Co+3]"
              }
            ],
            "sub_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/out/f911b349-554b-479c-97b2-d2f6c9bf7e26.png",
            "openbabel_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/remake/f911b349-554b-479c-97b2-d2f6c9bf7e26.png",
            "sub_image_id_mongodb": "656690cdf89411bd8490ac45",
            "openbabel_image_id_mongodb": "656690cdf89411bd8490ac47"
          }
        ]
      },
      {
        "names": [
          "4 ( BDOTA + )"
        ],
        "uvvis_spectra": [
          {
            "solvent": "CH2Cl2",
            "apparatus": "PerkinElmer Lambda 1050 UV",
            "peaks": [
              {
                "value": "578",
                "units": "nm"
              }
            ]
          }
        ],
        "quantum_yields": [
          {
            "value": "0.78",
            "solvent": "CH2Cl2",
            "type": "\u03a6f"
          }
        ],
        "fluorescence_lifetimes": [
          {
            "value": "20.2",
            "units": "ns",
            "solvent": "CH2Cl2"
          }
        ],
        "electrochemical_potentials": [
          {
            "value": "2.060",
            "type": "Eox"
          },
          {
            "value": "\u20130.226",
            "type": "Ered"
          },
          {
            "value": "\u20131.233",
            "type": "Ered"
          }
        ],
        "smiles": [
          {
            "alter_name": "4",
            "alter_name_confidence": 0.9998148083686829,
            "alter_name_not_original": "False",
            "pubchem_name_check": [],
            "alter_smiles": "c1cc2ccc3c4c2c(c1)c1cccc2c1[Co]4c1c(o3)cccc1o2",
            "alter_smiles_confidence": 3.27661,
            "pubchem_smiles_check": [
              {
                "formula": null,
                "smiles": "C1=CC2=C3[C-]=C(C=C2)OC4=CC=CC(=[C-]4)OC5=CC=CC(=[C-]5)C3=C1.[Co+3]"
              }
            ],
            "sub_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/out/75a2777c-7764-4447-ac77-ff06133949a7.png",
            "openbabel_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/remake/75a2777c-7764-4447-ac77-ff06133949a7.png",
            "sub_image_id_mongodb": "656690dbf89411bd8490ac49",
            "openbabel_image_id_mongodb": "656690dbf89411bd8490ac4b"
          }
        ]
      },
      {
        "names": [
          "14 ( BDATA + )"
        ],
        "uvvis_spectra": [
          {
            "solvent": "CH2Cl2",
            "apparatus": "PerkinElmer Lambda 1050 UV",
            "peaks": [
              {
                "value": "625",
                "units": "nm"
              }
            ]
          }
        ],
        "quantum_yields": [
          {
            "value": "0.30",
            "solvent": "CH2Cl2",
            "type": "\u03a6f"
          }
        ],
        "fluorescence_lifetimes": [
          {
            "value": "12.2",
            "units": "ns",
            "solvent": "CH2Cl2"
          }
        ],
        "electrochemical_potentials": [
          {
            "value": "1.215",
            "type": "Eox"
          },
          {
            "value": "\u20130.874",
            "type": "Ered"
          },
          {
            "value": "\u20131.594",
            "type": "Ered"
          }
        ],
        "smiles": [
          {
            "alter_name": "14",
            "alter_name_confidence": 0.9999552369117737,
            "alter_name_not_original": "False",
            "pubchem_name_check": [],
            "alter_smiles": "Cn1c2cccc3c2[Co]2c4c1cccc4n(c1c2c2c3cccc2cc1)C",
            "alter_smiles_confidence": 3.95826,
            "pubchem_smiles_check": [
              {
                "formula": null,
                "smiles": "CN1C2=[C-]C(=CC=C2)N(C3=[C-]C4=C(C=CC=C4C5=[C-]C1=CC=C5)C=C3)C.[Co+3]"
              }
            ],
            "sub_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/out/e3dd076c-98f1-42ac-bcad-1ca54da471fa.png",
            "openbabel_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/remake/e3dd076c-98f1-42ac-bcad-1ca54da471fa.png",
            "sub_image_id_mongodb": "656690e9f89411bd8490ac4d",
            "openbabel_image_id_mongodb": "656690e9f89411bd8490ac4f"
          }
        ]
      },
      {
        "names": [
          "CAOTA+",
          "CAOTA +"
        ],
        "electrochemical_potentials": [
          {
            "value": "1.723",
            "type": "Eox"
          },
          {
            "value": "\u20130.652",
            "type": "Ered"
          }
        ],
        "smiles": [
          {
            "alter_name": "CAOTA+",
            "alter_name_confidence": 0.9940845492565131,
            "alter_name_not_original": "True",
            "pubchem_name_check": [],
            "alter_smiles": "CN1c2cccc3c2[Co]2c4c1cccc4C(c1c2c(O3)ccc1)(C)C",
            "alter_smiles_confidence": 3.59508,
            "pubchem_smiles_check": [
              {
                "formula": null,
                "smiles": "CC1(C2=[C-]C(=CC=C2)N(C3=[C-]C(=CC=C3)OC4=CC=CC1=[C-]4)C)C.[Co+3]"
              }
            ],
            "sub_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/out/4cedd1f6-d6df-429e-adc7-c87ad8a0b0bd.png",
            "openbabel_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/remake/4cedd1f6-d6df-429e-adc7-c87ad8a0b0bd.png",
            "sub_image_id_mongodb": "656690f3f89411bd8490ac51",
            "openbabel_image_id_mongodb": "656690f4f89411bd8490ac53"
          }
        ]
      },
      {
        "names": [
          "11-Methoxy-3,7-dimethyl-3,7-dihydrobenzo[a]quinolino[2,3,4-kl]acridinium Hexafluorophosphate"
        ],
        "uvvis_spectra": [
          {
            "solvent": "CH2Cl2",
            "apparatus": "PerkinElmer Lambda 1050 UV",
            "peaks": [
              {
                "value": "613",
                "units": "nm"
              }
            ]
          }
        ],
        "quantum_yields": [
          {
            "value": "0.35",
            "solvent": "CH2Cl2",
            "type": "\u03a6f"
          }
        ],
        "fluorescence_lifetimes": [
          {
            "value": "12.7",
            "units": "ns",
            "solvent": "CH2Cl2"
          }
        ],
        "electrochemical_potentials": [
          {
            "value": "1.265",
            "type": "Eox"
          },
          {
            "value": "1.941",
            "type": "Eox"
          },
          {
            "value": "\u20130.799",
            "type": "Ered"
          },
          {
            "value": "\u20131.544",
            "type": "Ered"
          }
        ],
        "smiles": "F[P-](F)(F)(F)(F)F.COC=1C2=C(C=CC1)N(C=1C=CC=C3[NH+](C4=CCC5=C(C4=C2C13)C=CC=C5)C)C"
      },
      {
        "names": [
          "Benzo[a]chromeno[2,3,4-kl]xanthenium Hexafluorophosphate"
        ],
        "uvvis_spectra": [
          {
            "solvent": "CH2Cl2",
            "apparatus": "PerkinElmer Lambda 1050 UV",
            "peaks": [
              {
                "value": "564",
                "units": "nm"
              }
            ]
          }
        ],
        "quantum_yields": [
          {
            "value": "0.18",
            "solvent": "CH2Cl2",
            "type": "\u03a6f"
          }
        ],
        "fluorescence_lifetimes": [
          {
            "value": "6.6",
            "units": "ns",
            "solvent": "CH2Cl2"
          }
        ],
        "electrochemical_potentials": [
          {
            "value": "2.190",
            "type": "Eox"
          },
          {
            "value": "\u20130.121",
            "type": "Ered"
          }
        ],
        "smiles": "F[P-](F)(F)(F)(F)F.C1=C2C(=C3C4=C5C(=CC=CC5=[O+]C3=C1)OC=1C=CC=CC14)C=CC=C2"
      },
      {
        "names": [
          "3,7-Dimethyl-3,7-dihydrobenzo[a]quinolino[2,3,4-kl]acridinium Hexafluorophosphate"
        ],
        "uvvis_spectra": [
          {
            "solvent": "CH2Cl2",
            "apparatus": "PerkinElmer Lambda 1050 UV",
            "peaks": [
              {
                "value": "614",
                "units": "nm"
              }
            ]
          }
        ],
        "quantum_yields": [
          {
            "value": "0.31",
            "solvent": "CH2Cl2",
            "type": "\u03a6f"
          }
        ],
        "fluorescence_lifetimes": [
          {
            "value": "10.2",
            "units": "ns",
            "solvent": "CH2Cl2"
          }
        ],
        "electrochemical_potentials": [
          {
            "value": "1.287",
            "type": "Eox"
          },
          {
            "value": "\u20130.782",
            "type": "Ered"
          }
        ],
        "smiles": "F[P-](F)(F)(F)(F)F.C[NH+]1C2=CCC3=C(C2=C2C4=C(C=CC=C14)N(C=1C=CC=CC12)C)C=CC=C3"
      },
      {
        "names": [
          "CDATA+",
          "CDATA +"
        ],
        "electrochemical_potentials": [
          {
            "value": "1.290",
            "type": "Eox"
          },
          {
            "value": "\u20130.871",
            "type": "Ered"
          },
          {
            "value": "\u20131.615",
            "type": "Ered"
          }
        ],
        "smiles": [
          {
            "alter_name": "CDATA+",
            "alter_name_confidence": 0.9486436771513951,
            "alter_name_not_original": "True",
            "pubchem_name_check": [],
            "alter_smiles": "CN1c2cccc3c2[Co]2c4c1cccc4C(c1c2c(N3C)ccc1)(C)C",
            "alter_smiles_confidence": 3.242,
            "pubchem_smiles_check": [
              {
                "formula": null,
                "smiles": "CC1(C2=[C-]C(=CC=C2)N(C3=[C-]C(=CC=C3)N(C4=CC=CC1=[C-]4)C)C)C.[Co+3]"
              }
            ],
            "sub_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/out/8930d162-3afa-4df9-a388-146e4bb769e1.png",
            "openbabel_image_path": "/Users/luoyu/PycharmProjects/chemwork/image/remake/8930d162-3afa-4df9-a388-146e4bb769e1.png",
            "sub_image_id_mongodb": "656690fef89411bd8490ac55",
            "openbabel_image_id_mongodb": "656690fef89411bd8490ac57"
          }
        ]
      }
    ]
  }
]
```

